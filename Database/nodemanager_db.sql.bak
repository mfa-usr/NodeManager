/* check whether the database exists, and if so, delete it */
IF EXISTS (SELECT 1 FROM master.dbo.sysdatabases
				WHERE name = 'nodemanager_db')
BEGIN
	DROP DATABASE nodemanager_db
	print '' print '*** dropped database nodemanager_db ***'
END
GO

print '' print '*** creating database nodemanager_db ***'
GO

CREATE DATABASE nodemanager_db
GO

print '' print '*** using database nodemanager_db ***'

USE [nodemanager_db]
GO

/* User table */
print '' print '*** creating users table ***'
GO
CREATE TABLE [dbo].[Users] (
	[UserID]		[int] IDENTITY(10000,1)		NOT NULL,
	[FirstName]		[nvarchar](50)				NOT NULL,
	[LastName]		[nvarchar](100)				NOT NULL,
	[Phone]			[nvarchar](13)				NOT NULL,
	[Email]			[nvarchar](250)				NOT NULL,
	[PasswordHash]	[nvarchar](100)				NOT NULL DEFAULT
		'1f489582f7ea4c208b70219a2bb6a322227a7516630530a10ed7f2710cfbe447',
	[Active]		[bit]						NOT NULL DEFAULT 1,
	CONSTRAINT [pk_UserID] 	PRIMARY KEY([UserID]),
	CONSTRAINT [ak_Email] 	UNIQUE([Email])
)
GO

/* User records */
print '' print '*** inserting users records ****'
GO
INSERT INTO [dbo].[Users]
		([FirstName], [LastName], [Phone], [Email])
    VALUES
		('Henry', 'Waternoose', '3195551111', 'henry@company.com'),
		('Mike', 'Wazowski', '3195552222', 'mike@company.com'),
		('James', 'Sullivan', '3195553333', 'james@company.com'),
		('Randall', 'Boggs', '3195554444', 'randall@company.com')
GO

/* Roles table and data */
print '' print '*** creating roles table ***'
GO
CREATE TABLE [dbo].[Roles] (
	[RoleID]		[nvarchar](50)	NOT NULL,
	[Description]	[nvarchar](250)	NULL,
	CONSTRAINT [pk_RoleID] PRIMARY KEY ([RoleID])
)
GO

print '' print '*** inserting roles records ***'
	INSERT INTO [dbo].[Roles]
		([RoleID], [Description])
	VALUES
		('Admin', 'administers application and can make changes to critical items'),
		('User', 'users of the application')
GO

/*** UsersRoles join table to join Users and Roles ***/

print '' print '*** creating usersroles table ***'
GO
CREATE TABLE [dbo].[UsersRoles] (
	[UserID]		[int] 						NOT NULL,	
	[RoleID]		[nvarchar](50)				NOT NULL,	
	CONSTRAINT [fk_UsersRoles_UserID] FOREIGN KEY ([UserID])
		REFERENCES [dbo].[Users]([UserID]),	
	CONSTRAINT [fk_UsersRoles_RoleID] FOREIGN KEY ([RoleID])
		REFERENCES [dbo].[Roles]([RoleID]),
	CONSTRAINT [pk_UsersRoles] PRIMARY KEY ([UserID], [RoleID])
)
GO

print '' print '*** inserting usersroles records ***'
GO
INSERT INTO [dbo].[UsersRoles]
		([UserID], [RoleID])
	VALUES
		(10000, 'Admin'),
		(10001, 'User'),
		(10002, 'User'),
		(10003, 'User')
GO

/* login-related stored procedures */

print '' print '*** creating sp_authenticate_user ***'
GO
CREATE PROCEDURE [dbo].[sp_authenticate_user]
(
	@Email				[nvarchar](250),
	@PasswordHash		[nvarchar](100)
)
AS
	BEGIN
		SELECT 	COUNT([UserID]) AS 'Authenticated'
		 FROM	[Users]
		WHERE	@Email = [Email]
		  AND	@PasswordHash = [PasswordHash]
		  AND	[Active] = 1
	END
GO

print '' print '*** creating sp_select_user_by_email'
GO
CREATE PROCEDURE [dbo].[sp_select_user_by_email]
(
	@Email				[nvarchar](250)			
)
AS
	BEGIN
		SELECT 	[UserID], [FirstName], [LastName], 
				[Phone], [Email], [Active]
		FROM	[Users]
		WHERE	@Email = [Email]
	END
GO

print '' print '*** creating sp_select_roles_by_UserID'
GO
CREATE PROCEDURE [dbo].[sp_select_roles_by_UserID]
(
	@UserID		[int]			
)
AS
	BEGIN
		SELECT 	[RoleID]
		FROM	[UsersRoles]
		WHERE	@UserID = [UserID]
	END
GO

/*** Nodes table ***/

print '' print '*** inserting nodes table ***'
GO
CREATE TABLE [dbo].[Nodes] (
	[NodeID]		[int] IDENTITY(1,1)	NOT NULL,
	[octet1]		[tinyint]			NOT NULL,
	[octet2]		[tinyint]			NOT NULL,
	[octet3]		[tinyint]			NOT NULL,
	[octet4]		[tinyint]			NOT NULL,
	[Responding]	[bit],
	CONSTRAINT 		[pk_NodeID] 		PRIMARY KEY([NodeID])
)
GO

print '' print '*** inserting nodes records ****'
GO
INSERT INTO [dbo].[Nodes]
		([octet1], [octet2], [octet3], [octet4], [Responding])
    VALUES
		(172,217,1,110,1),
		(185,125,190,29,1),
		(172,67,148,63,1),
		(130,89,148,77,1),
		(40,89,244,232,1)
GO

print '' print '*** creating sp_add_node ***'
GO
CREATE PROCEDURE add_node
    @octet1 tinyint,
    @octet2 tinyint,
    @octet3 tinyint,
    @octet4 tinyint,
    @Responding bit
AS
	BEGIN
		INSERT INTO [dbo].[Nodes]
			([octet1], [octet2], [octet3], [octet4], [Responding])
		VALUES
			(@octet1, @octet2, @octet3, @octet4, @Responding)
	END
GO

print '' print '*** creating sp_delete_node ***'
GO
CREATE PROCEDURE delete_node
    @NodeID int
AS
	BEGIN
		DELETE FROM [dbo].[Nodes]
		WHERE [NodeID] = @NodeID
	END
GO


print '' print '*** creating sp_select_all_nodes ***'
GO
	CREATE PROCEDURE sp_select_all_nodes
	AS
	BEGIN
		SELECT [NodeID], [octet1], [octet2], [octet3], [octet4], [Responding]
		FROM   [dbo].[Nodes]
	END
GO
	